<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XPSF: Infinite</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <style>
    :root {
      --bg-color: black;
      --text-color: #00ff00;
      --accent-color: #00ff00;
      --secondary-bg: #003300;
      --button-bg: #330000;
      --button-hover-bg: #550000;
    }
    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 2rem;
      height: 100vh;
      margin: 0;
      position: relative;
    }
    .palette-selector {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 9999;
      font-family: monospace;
    }
    .palette-selector label {
      color: var(--text-color);
      font-size: 0.8rem;
      margin-right: 8px;
    }
    .palette-selector select {
      background-color: var(--button-bg);
      color: var(--text-color);
      border: 1px solid var(--accent-color);
      border-radius: 4px;
      padding: 4px 8px;
      font-family: monospace;
      font-size: 0.75rem;
      cursor: pointer;
    }
    .palette-selector select:focus {
      outline: 2px solid var(--accent-color);
      outline-offset: 2px;
    }
    #clearDataBtn {
      position: fixed;
      top: 10px;
      left: 10px;
      background-color: var(--button-bg);
      border: 1.5px solid var(--accent-color);
      color: var(--text-color);
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 0.75rem;
      cursor: pointer;
      opacity: 0.6;
      transition: opacity 0.3s ease, background-color 0.3s ease;
      user-select: none;
      z-index: 9999;
      font-family: monospace;
    }
    #clearDataBtn:hover {
      background-color: var(--button-hover-bg);
      opacity: 1;
    }
    h1 { margin-bottom: 1rem; }
    .stat { margin: 0.5rem 0; font-size: 1.2rem; }
    #xp-bar {
      width: 80%; max-width: 400px; height: 30px;
      background: var(--secondary-bg);
      border: 2px solid var(--accent-color);
      border-radius: 12px;
      position: relative;
      margin: 1rem 0;
      overflow: hidden;
    }
    #xp-fill {
      height: 100%;
      background: var(--accent-color);
      width: 0%;
      transition: width 0.5s ease;
      border-radius: 10px 0 0 10px;
    }
    #xp-fill.full { border-radius: 10px; }
    .button-group { display: flex; gap: 1rem; margin-top: 2rem; }
    button {
      background-color: var(--button-bg);
      border: 2px solid var(--accent-color);
      color: var(--text-color);
      border-radius: 10px;
      padding: 12px 24px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.1s ease;
      user-select: none;
      font-family: monospace;
    }
    button:hover { background-color: var(--button-hover-bg); }
    button:active { transform: scale(0.95); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    /* Pandemonium overlay (minigame) */
    #pandemoniumOverlay {
      display: none;
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: 10000;
      background: rgba(0,0,0,0.85);
      align-items: center; justify-content: center; flex-direction: column;
      cursor: none;
    }
    /* Centered minigame style */
    #pandGameBox {
      position: relative;
      width: 300px;
      height: 300px;
      margin-bottom: 36px;
    }
    #pandCenterRing {
      position: absolute;
      left: 50px; top: 50px;
      width: 200px; height: 200px;
      border: 5px solid #ff3366;
      border-radius: 50%;
      box-sizing: border-box;
      z-index: 10;
    }
    #pandCursorBall {
      position: absolute;
      width: 40px; height: 40px;
      border-radius: 50%;
      background: #12e56c;
      box-shadow: 0 0 18px #fff;
      border: 2.5px solid #fff;
      z-index: 30;
      pointer-events: none;
    }
    #pandBarContainer {
      margin-top: 20px;
      width: 320px; height: 28px; background: #222;
      border: 2px solid #FFF;
      border-radius: 13px;
      overflow: hidden;
    }
    #pandBar {
      height: 100%;
      width: 100%;
      background: #12e56c;
      transition: width 0.1s;
    }
    #pandStatus { color: #FFF; margin-top: 12px; font-size: 1.1rem; }
    #pandStartBtn {
      margin-top: 32px;
      font-family: monospace;
      font-size: 1.1rem;
      padding: 10px 30px;
      border-radius: 8px;
      border: 2px solid #888;
      background: #181818;
      color: #fff;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Color Palette Selector -->
  <div class="palette-selector">
    <label for="colorPalette">Theme:</label>
    <select id="colorPalette" onchange="changeColorPalette(this.value)">
      <option value="default">Default (Green/Black)</option>
      <option value="blue-yellow">Blue/Yellow</option>
      <option value="white-black">White/Black</option>
      <option value="high-contrast">High Contrast</option>
    </select>
  </div>
  <!-- Clear Data Button -->
  <button id="clearDataBtn">Clear Data</button>
  <h1>XPSF: Infinite</h1>
  <div class="stat" id="levelDisplay">Level: 1</div>
  <div class="stat" id="xpDisplay">XP: 0 / 100</div>
  <div class="stat" id="xpLeftDisplay">XP Left: 100</div>
  <div class="stat" id="upgradeDisplay">Multiplier: 1x</div>
  <div id="xp-bar"><div id="xp-fill"></div></div>
  <div class="button-group">
    <button id="fightBtn">Fight</button>
    <button id="upgradeBtn">Upgrade (Cost: 2 Levels)</button>
  </div>
  <!-- Pandemonium FPS minigame overlay -->
  <div id="pandemoniumOverlay">
    <div id="pandGameBox">
      <div id="pandCenterRing"></div>
      <div id="pandCursorBall"></div>
    </div>
    <div id="pandBarContainer">
      <div id="pandBar"></div>
    </div>
    <div id="pandStatus"></div>
    <button id="pandStartBtn" style="display:none;">Start Minigame</button>
  </div>
  <!-- AUDIO -->
  <audio id="pandAudio" src="audio.mp3" loop></audio>
  <script>
    let xp = parseInt(localStorage.getItem('xpsf-xp')) || 0;
    let level = parseInt(localStorage.getItem('xpsf-level')) || 1;
    let multiplier = parseInt(localStorage.getItem('xpsf-multiplier')) || 1;

    const savedPalette = localStorage.getItem('xpsf-color-palette') || 'default';
    document.getElementById('colorPalette').value = savedPalette;
    changeColorPalette(savedPalette);

    function getBaseXP(level) { return 100 + (level - 1) * 50; }
    function saveGame() {
      localStorage.setItem('xpsf-xp', xp);
      localStorage.setItem('xpsf-level', level);
      localStorage.setItem('xpsf-multiplier', multiplier);
    }
    function changeColorPalette(palette) {
      const root = document.documentElement;
      switch(palette) {
        case 'blue-yellow':
          root.style.setProperty('--bg-color', '#000080');
          root.style.setProperty('--text-color', '#FFFF00');
          root.style.setProperty('--accent-color', '#FFFF00');
          root.style.setProperty('--secondary-bg', '#000040');
          root.style.setProperty('--button-bg', '#000060');
          root.style.setProperty('--button-hover-bg', '#0000A0');
          break;
        case 'white-black':
          root.style.setProperty('--bg-color', 'white');
          root.style.setProperty('--text-color', 'black');
          root.style.setProperty('--accent-color', '#333333');
          root.style.setProperty('--secondary-bg', '#F0F0F0');
          root.style.setProperty('--button-bg', '#E0E0E0');
          root.style.setProperty('--button-hover-bg', '#D0D0D0');
          break;
        case 'high-contrast':
          root.style.setProperty('--bg-color', 'black');
          root.style.setProperty('--text-color', 'white');
          root.style.setProperty('--accent-color', 'white');
          root.style.setProperty('--secondary-bg', '#333333');
          root.style.setProperty('--button-bg', '#666666');
          root.style.setProperty('--button-hover-bg', '#888888');
          break;
        case 'default': default:
          root.style.setProperty('--bg-color', 'black');
          root.style.setProperty('--text-color', '#00ff00');
          root.style.setProperty('--accent-color', '#00ff00');
          root.style.setProperty('--secondary-bg', '#003300');
          root.style.setProperty('--button-bg', '#330000');
          root.style.setProperty('--button-hover-bg', '#550000');
          break;
      }
      localStorage.setItem('xpsf-color-palette', palette);
    }
    function updateUI() {
      const baseXP = getBaseXP(level);
      document.getElementById('levelDisplay').textContent = `Level: ${level}`;
      document.getElementById('xpDisplay').textContent = `XP: ${Math.floor(xp)} / ${baseXP}`;
      document.getElementById('xpLeftDisplay').textContent = `XP Left: ${Math.max(0, Math.floor(baseXP - xp))}`;
      document.getElementById('upgradeDisplay').textContent = `Multiplier: ${multiplier}x`;
      const xpPercent = Math.min((xp / baseXP) * 100, 100);
      const xpFill = document.getElementById('xp-fill');
      xpFill.style.width = `${xpPercent}%`;
      if (xpPercent >= 100) xpFill.classList.add('full');
      else xpFill.classList.remove('full');
    }

    // Anti-AutoClicker: Pandemonium detection
    let levelsThisMinute = 0, minuteStartTime = Date.now();
    let lastClickTimes = [];
    const PAND_DETECTION_LEVELS = 50, PAND_DETECTION_CLICKS = 20;
    let fightAllowed = true;

    function fight(event) {
      if (!fightAllowed || pandActive) return;
      const now = Date.now();
      lastClickTimes.push(now);
      if (lastClickTimes.length > PAND_DETECTION_CLICKS) lastClickTimes.shift();
      if (now - minuteStartTime > 60000) {
        levelsThisMinute = 0;
        minuteStartTime = now;
      }
      const baseXP = getBaseXP(level);
      const xpGains = [20,25,30,35,40,45,50];
      const baseGain = xpGains[Math.floor(Math.random() * xpGains.length)];
      const gained = baseGain * multiplier;
      let initialLevel = level;
      xp += gained;
      while (xp >= getBaseXP(level)) {
        xp -= getBaseXP(level);
        level++;
      }
      saveGame();
      updateUI();
      if (level > initialLevel) levelsThisMinute += (level - initialLevel);
      if (levelsThisMinute >= PAND_DETECTION_LEVELS && lastClickTimes.length === PAND_DETECTION_CLICKS) {
        let intervals = lastClickTimes.slice(1).map((t,i)=>t-lastClickTimes[i]);
        let avg = intervals.reduce((a,b)=>a+b,0)/intervals.length;
        let consistent = intervals.every(intv => Math.abs(intv - avg) < 10);
        if (consistent) {
          triggerPandemonium();
          levelsThisMinute = 0;
          fightAllowed = false;
          return;
        }
      }
    }
    function upgrade() {
      if (pandActive) return;
      if (level >= 3) {
        level -= 2;
        multiplier++;
        const baseXP = getBaseXP(level);
        if (xp > baseXP) xp = baseXP;
        saveGame();
        updateUI();
      } else {
        alert('Need at least 3 levels to upgrade!');
      }
    }
    function clearData() {
      if (confirm("This will delete ALL your progress. Are you sure?")) {
        localStorage.clear();
        xp = 0; level = 1; multiplier = 1;
        document.getElementById('colorPalette').value = 'default';
        changeColorPalette('default');
        updateUI();
      }
    }
    document.getElementById('fightBtn').addEventListener('click', fight);
    document.getElementById('upgradeBtn').addEventListener('click', upgrade);
    document.getElementById('clearDataBtn').addEventListener('click', clearData);
    updateUI();

    // --------- Pandemonium: FPS Pointer-Lock Ball Minigame (shake, audio, small ring, 42s) ---------
    let pandBarVal = 1, pandBarDrain = 0.017, pandBarFill = 0.027, pandDuration = 42, pandElapsed = 0, pandInterval = null, pandThrowInterval = null, shakeloop = null;
    let ballX = 150, ballY = 150, shakeTime = 0, shakePhaseX = Math.random()*100, shakePhaseY = Math.random()*100;
    const ballRadius = 20, ringRadius = 80;
    let pandActive = false;

    function triggerPandemonium() {
      pandActive = true; pandBarVal = 1; pandElapsed = 0;
      ballX = 150; ballY = 150;
      document.getElementById('pandemoniumOverlay').style.display = 'flex';
      document.getElementById('pandCursorBall').style.left = (ballX-ballRadius) + 'px';
      document.getElementById('pandCursorBall').style.top = (ballY-ballRadius) + 'px';
      document.getElementById('pandStatus').textContent = 'Keep the jittery ball inside the SMALL ring!';
      document.getElementById('pandStartBtn').style.display = 'block';
      document.getElementById('pandStartBtn').onclick = function() {
        document.getElementById('pandStartBtn').style.display = 'none';
        let gameBox = document.getElementById('pandGameBox');
        gameBox.requestPointerLock = gameBox.requestPointerLock || gameBox.mozRequestPointerLock;
        gameBox.requestPointerLock();
      };
    }
    document.addEventListener('pointerlockchange', pointerLockChange, false);
    document.addEventListener('mozpointerlockchange', pointerLockChange, false);
    function pointerLockChange() {
      let locked = document.pointerLockElement === document.getElementById('pandGameBox') ||
          document.mozPointerLockElement === document.getElementById('pandGameBox');
      if (locked && pandActive) startPandemoniumCore();
    }
    function startPandemoniumCore() {
      document.body.style.cursor = 'none';
      shakeTime = 0;
      shakeloop = requestAnimationFrame(ballSmoothShake);
      pandThrowInterval = setInterval(pandThrowBall, 5000);
      pandInterval = setInterval(pandBallTick, 40);
      window.addEventListener("mousemove", moveBallByMouse, false);

      // Play minigame audio on a user gesture
      let a = document.getElementById('pandAudio');
      a.currentTime = 0;
      a.play().catch(()=>{}); // fail silently if blocked
    }
    function endPandemoniumCore(win) {
      clearInterval(pandInterval); clearInterval(pandThrowInterval); cancelAnimationFrame(shakeloop);
      window.removeEventListener("mousemove", moveBallByMouse);
      document.body.style.cursor = '';
      document.exitPointerLock = document.exitPointerLock || document.mozExitPointerLock;
      try { document.exitPointerLock(); } catch(e) {}

      // Stop/rewind audio
      let a = document.getElementById('pandAudio'); a.pause(); a.currentTime = 0;

      let status = document.getElementById('pandStatus');
      if (win) status.textContent = 'You survived Pandemonium! Click to continue.';
      else status.textContent = 'You failed! Click to try again.';
      document.getElementById('pandemoniumOverlay').onclick = function() {
        document.getElementById('pandemoniumOverlay').style.display = 'none';
        document.getElementById('pandemoniumOverlay').onclick = null;
        fightAllowed = true;
        if (!win) triggerPandemonium();
      }
    }
    function moveBallByMouse(e) {
      if (!pandActive) return;
      ballX += e.movementX;
      ballY += e.movementY;
      ballX = Math.max(ballRadius+10, Math.min(300-ballRadius-10, ballX));
      ballY = Math.max(ballRadius+10, Math.min(300-ballRadius-10, ballY));
    }
    function ballSmoothShake() {
      shakeTime += 0.04;
      let maxShake = 5;
      let shakeX = Math.sin(shakePhaseX + shakeTime*0.8)*maxShake + Math.sin(shakePhaseY + shakeTime*1.3)*maxShake*0.6;
      let shakeY = Math.cos(shakePhaseY + shakeTime*0.85)*maxShake + Math.cos(shakePhaseX + shakeTime*1.11)*maxShake*0.5;
      document.getElementById('pandCursorBall').style.left = (ballX-ballRadius+shakeX) + 'px';
      document.getElementById('pandCursorBall').style.top = (ballY-ballRadius+shakeY) + 'px';
      if (pandActive) shakeloop = requestAnimationFrame(ballSmoothShake);
    }
    function pandBallTick() {
      let dx = ballX-150, dy = ballY-150;
      let inRing = Math.sqrt(dx*dx+dy*dy) <= ringRadius;
      if (inRing) {
        pandBarVal = Math.min(1, pandBarVal + pandBarFill);
        pandElapsed += 0.04;
      } else {
        pandBarVal = Math.max(0, pandBarVal - pandBarDrain);
      }
      document.getElementById('pandBar').style.width = (pandBarVal*100) + "%";
      if (pandElapsed >= pandDuration) endPandemoniumCore(true);
      if (pandBarVal <= 0) endPandemoniumCore(false);
    }
    function pandThrowBall() {
      let angle = Math.random()*Math.PI*2, r = 63 + Math.random()*11;
      ballX = 150 + Math.cos(angle)*r;
      ballY = 150 + Math.sin(angle)*r;
    }
  </script>
</body>
</html>
