<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XPSF: Infinite</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <style>
    :root {
      --bg-color: black;
      --text-color: #00ff00;
      --accent-color: #00ff00;
      --secondary-bg: #003300;
      --button-bg: #330000;
      --button-hover-bg: #550000;
    }
    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 2rem;
      height: 100vh;
      margin: 0;
      position: relative;
    }
    .palette-selector {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 9999;
      font-family: monospace;
    }
    .language-selector {
      position: fixed;
      top: 50px;
      right: 10px;
      z-index: 9999;
      font-family: monospace;
    }
    .palette-selector label, .language-selector label {
      color: var(--text-color);
      font-size: 0.8rem;
      margin-right: 8px;
    }
    .palette-selector select, .language-selector select {
      background-color: var(--button-bg);
      color: var(--text-color);
      border: 1px solid var(--accent-color);
      border-radius: 4px;
      padding: 4px 8px;
      font-family: monospace;
      font-size: 0.75rem;
      cursor: pointer;
    }
    .palette-selector select:focus, .language-selector select:focus {
      outline: 2px solid var(--accent-color);
      outline-offset: 2px;
    }
    #clearDataBtn {
      position: fixed;
      top: 10px;
      left: 10px;
      background-color: var(--button-bg);
      border: 1.5px solid var(--accent-color);
      color: var(--text-color);
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 0.75rem;
      cursor: pointer;
      opacity: 0.6;
      transition: opacity 0.3s ease, background-color 0.3s ease;
      user-select: none;
      z-index: 9999;
      font-family: monospace;
    }
    #clearDataBtn:hover {
      background-color: var(--button-hover-bg);
      opacity: 1;
    }
    h1 { margin-bottom: 1rem; }
    .stat { margin: 0.5rem 0; font-size: 1.2rem; }
    #xp-bar {
      width: 80%; max-width: 400px; height: 30px;
      background: var(--secondary-bg);
      border: 2px solid var(--accent-color);
      border-radius: 12px;
      position: relative;
      margin: 1rem 0;
      overflow: hidden;
    }
    #xp-fill {
      height: 100%;
      background: var(--accent-color);
      width: 0%;
      transition: width 0.5s ease;
      border-radius: 10px 0 0 10px;
    }
    #xp-fill.full { border-radius: 10px; }
    .button-group { display: flex; gap: 1rem; margin-top: 2rem; }
    button {
      background-color: var(--button-bg);
      border: 2px solid var(--accent-color);
      color: var(--text-color);
      border-radius: 10px;
      padding: 12px 24px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.1s ease;
      user-select: none;
      font-family: monospace;
    }
    button:hover { background-color: var(--button-hover-bg); }
    button:active { transform: scale(0.95); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    #pandemoniumOverlay {
      display: none;
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: 10000;
      background: rgba(0,0,0,0.88);
      align-items: center; justify-content: center; flex-direction: column;
      cursor: none;
    }
    #pandGameBox {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      pointer-events: none;
      z-index: 2;
    }
    #pandCenterRing {
      position: fixed;
      border: 5px solid #ff3366;
      border-radius: 50%;
      pointer-events: none;
      z-index: 3;
    }
    #pandCursorBall {
      position: fixed;
      width: 40px; height: 40px;
      border-radius: 50%;
      background: #12e56c;
      box-shadow: 0 0 18px #fff;
      border: 2.5px solid #fff;
      z-index: 4;
      pointer-events: none;
    }
    #pandBarContainer {
      /* dynamically positioned, so remove margin, etc. */
      height: 28px; background: #222;
      border: 2px solid #FFF;
      border-radius: 13px;
      overflow: hidden;
      z-index: 15;
      position: fixed;
    }
    #pandBar {
      height: 100%;
      width: 100%;
      background: #12e56c;
      transition: width 0.1s;
    }
    #pandStatus {
      color: #FFF;
      font-size: 1.1rem;
      z-index: 15;
      position: fixed;
      width: 400px;
      left: 50%; transform: translateX(-50%);
      text-align: center;
    }
    #pandStartBtn {
      margin-top: 32px;
      font-family: monospace;
      font-size: 1.1rem;
      padding: 10px 30px;
      border-radius: 8px;
      border: 2px solid #888;
      background: #181818;
      color: #fff;
      cursor: pointer;
      z-index: 16;
    }
  </style>
</head>
<body>
  <!-- Color Palette Selector -->
  <div class="palette-selector">
    <label for="colorPalette" id="themeLabel">Theme:</label>
    <select id="colorPalette" onchange="changeColorPalette(this.value)">
      <option value="default">Default (Green/Black)</option>
      <option value="blue-yellow">Blue/Yellow</option>
      <option value="white-black">White/Black</option>
      <option value="high-contrast">High Contrast</option>
    </select>
  </div>
  <!-- Language Switcher -->
  <div class="language-selector">
    <label for="languageSelect" id="langLabel">Lang:</label>
    <select id="languageSelect" onchange="changeLanguage(this.value)">
      <option value="en">English</option>
      <option value="hu">Magyar</option>
    </select>
  </div>
  <!-- Clear Data Button -->
  <button id="clearDataBtn">Clear Data</button>
  <h1 id="gameTitle">XPSF: Infinite</h1>
  <div class="stat" id="levelDisplay">Level: 1</div>
  <div class="stat" id="xpDisplay">XP: 0 / 100</div>
  <div class="stat" id="xpLeftDisplay">XP Left: 100</div>
  <div class="stat" id="upgradeDisplay">Multiplier: 1x</div>
  <div id="xp-bar"><div id="xp-fill"></div></div>
  <div class="button-group">
    <button id="fightBtn">Fight</button>
    <button id="upgradeBtn">Upgrade (Cost: 2 Levels)</button>
  </div>
  <!-- Pandemonium FPS minigame overlay covering the entire screen -->
  <div id="pandemoniumOverlay">
    <div id="pandGameBox">
      <div id="pandCenterRing"></div>
      <div id="pandCursorBall"></div>
    </div>
    <div id="pandBarContainer"><div id="pandBar"></div></div>
    <div id="pandStatus"></div>
    <button id="pandStartBtn" style="display:none;">Start Minigame</button>
  </div>
  <!-- AUDIO -->
  <audio id="pandAudio" src="audio.mp3" loop></audio>
  <script>
    // Language system - using variables instead of localStorage
    let currentLanguage = 'en';
    let gameData = {
      xp: 0,
      level: 1,
      multiplier: 1,
      colorPalette: 'default'
    };
    
    const translations = {
      en: {
        gameTitle: "XPSF: Infinite",
        clearData: "Clear Data",
        themeLabel: "Theme:",
        langLabel: "Lang:",
        level: "Level",
        xpLeft: "XP Left",
        multiplier: "Multiplier",
        fight: "Fight",
        upgrade: "Upgrade",
        upgradeCost: "Cost: 2 Levels",
        needLevels: "Need at least 3 levels to upgrade!",
        confirmClear: "This will delete ALL your progress. Are you sure?",
        pandKeepInside: "Keep the circle inside the middle.",
        pandSurvived: "You survived Pandemonium! Click to continue.",
        pandFailed: "You failed! Click to try again.",
        pandStart: "Start Minigame",
        colorDefault: "Default (Green/Black)",
        colorBlueYellow: "Blue/Yellow",
        colorWhiteBlack: "White/Black",
        colorHighContrast: "High Contrast"
      },
      hu: {
        gameTitle: "XPSF: Végtelen",
        clearData: "Adatok Törlése",
        themeLabel: "Téma:",
        langLabel: "Nyelv:",
        level: "Szint",
        xpLeft: "XP Hátra",
        multiplier: "Szorzó",
        fight: "Harc",
        upgrade: "Fejlesztés",
        upgradeCost: "Ár: 2 Szint",
        needLevels: "Legalább 3 szint kell a fejlesztéshez!",
        confirmClear: "Ez MINDEN haladásodat törli. Biztos vagy benne?",
        pandKeepInside: "Tartsd a kört a középen belül.",
        pandSurvived: "Túlélted a Pandémoniumot! Kattints a folytatáshoz.",
        pandFailed: "Kudarcot vallottál! Kattints az újrapróbáláshoz.",
        pandStart: "Minijáték Indítása",
        colorDefault: "Alapértelmezett (Zöld/Fekete)",
        colorBlueYellow: "Kék/Sárga",
        colorWhiteBlack: "Fehér/Fekete",
        colorHighContrast: "Nagy Kontraszt"
      }
    };

    function changeLanguage(lang) {
      currentLanguage = lang;
      updateLanguage();
    }

    function updateLanguage() {
      const t = translations[currentLanguage];
      
      // Update static text elements
      document.getElementById('gameTitle').textContent = t.gameTitle;
      document.getElementById('clearDataBtn').textContent = t.clearData;
      document.getElementById('themeLabel').textContent = t.themeLabel;
      document.getElementById('langLabel').textContent = t.langLabel;
      document.getElementById('fightBtn').textContent = t.fight;
      
      // Update color palette options
      const colorSelect = document.getElementById('colorPalette');
      colorSelect.options[0].textContent = t.colorDefault;
      colorSelect.options[1].textContent = t.colorBlueYellow;
      colorSelect.options[2].textContent = t.colorWhiteBlack;
      colorSelect.options[3].textContent = t.colorHighContrast;
      
      // Update dynamic UI
      updateUI();
    }

    let xp = gameData.xp;
    let level = gameData.level;
    let multiplier = gameData.multiplier;

    document.getElementById('colorPalette').value = gameData.colorPalette;
    changeColorPalette(gameData.colorPalette);

    // Initialize language - wait for DOM to be ready
    window.addEventListener('load', function() {
      document.getElementById('languageSelect').value = currentLanguage;
      updateLanguage();
    });

    function getBaseXP(level) { return 100 + (level - 1) * 50; }
    function saveGame() {
      gameData.xp = xp;
      gameData.level = level;
      gameData.multiplier = multiplier;
    }
    function changeColorPalette(palette) {
      const root = document.documentElement;
      switch(palette) {
        case 'blue-yellow':
          root.style.setProperty('--bg-color', '#000080');
          root.style.setProperty('--text-color', '#FFFF00');
          root.style.setProperty('--accent-color', '#FFFF00');
          root.style.setProperty('--secondary-bg', '#000040');
          root.style.setProperty('--button-bg', '#000060');
          root.style.setProperty('--button-hover-bg', '#0000A0');
          break;
        case 'white-black':
          root.style.setProperty('--bg-color', 'white');
          root.style.setProperty('--text-color', 'black');
          root.style.setProperty('--accent-color', '#333333');
          root.style.setProperty('--secondary-bg', '#F0F0F0');
          root.style.setProperty('--button-bg', '#E0E0E0');
          root.style.setProperty('--button-hover-bg', '#D0D0D0');
          break;
        case 'high-contrast':
          root.style.setProperty('--bg-color', 'black');
          root.style.setProperty('--text-color', 'white');
          root.style.setProperty('--accent-color', 'white');
          root.style.setProperty('--secondary-bg', '#333333');
          root.style.setProperty('--button-bg', '#666666');
          root.style.setProperty('--button-hover-bg', '#888888');
          break;
        case 'default': default:
          root.style.setProperty('--bg-color', 'black');
          root.style.setProperty('--text-color', '#00ff00');
          root.style.setProperty('--accent-color', '#00ff00');
          root.style.setProperty('--secondary-bg', '#003300');
          root.style.setProperty('--button-bg', '#330000');
          root.style.setProperty('--button-hover-bg', '#550000');
          break;
      }
      gameData.colorPalette = palette;
    }
    function updateUI() {
      const t = translations[currentLanguage];
      const baseXP = getBaseXP(level);
      
      document.getElementById('levelDisplay').textContent = `${t.level}: ${level}`;
      document.getElementById('xpDisplay').textContent = `XP: ${Math.floor(xp)} / ${baseXP}`;
      document.getElementById('xpLeftDisplay').textContent = `${t.xpLeft}: ${Math.max(0, Math.floor(baseXP - xp))}`;
      document.getElementById('upgradeDisplay').textContent = `${t.multiplier}: ${multiplier}x`;
      document.getElementById('upgradeBtn').textContent = `${t.upgrade} (${t.upgradeCost})`;
      
      const xpPercent = Math.min((xp / baseXP) * 100, 100);
      const xpFill = document.getElementById('xp-fill');
      xpFill.style.width = `${xpPercent}%`;
      if (xpPercent >= 100) xpFill.classList.add('full');
      else xpFill.classList.remove('full');
    }

    // Anti-AutoClicker: Pandemonium detection
    let levelsThisMinute = 0, minuteStartTime = Date.now();
    let lastClickTimes = [];
    const PAND_DETECTION_LEVELS = 50, PAND_DETECTION_CLICKS = 20;
    let fightAllowed = true;

    function fight(event) {
      if (!fightAllowed || pandActive) return;
      const now = Date.now();
      lastClickTimes.push(now);
      if (lastClickTimes.length > PAND_DETECTION_CLICKS) lastClickTimes.shift();
      if (now - minuteStartTime > 60000) {
        levelsThisMinute = 0;
        minuteStartTime = now;
      }
      const baseXP = getBaseXP(level);
      const xpGains = [20,25,30,35,40,45,50];
      const baseGain = xpGains[Math.floor(Math.random() * xpGains.length)];
      const gained = baseGain * multiplier;
      let initialLevel = level;
      xp += gained;
      while (xp >= getBaseXP(level)) {
        xp -= getBaseXP(level);
        level++;
      }
      saveGame();
      updateUI();
      if (level > initialLevel) levelsThisMinute += (level - initialLevel);
      if (levelsThisMinute >= PAND_DETECTION_LEVELS && lastClickTimes.length === PAND_DETECTION_CLICKS) {
        let intervals = lastClickTimes.slice(1).map((t,i)=>t-lastClickTimes[i]);
        let avg = intervals.reduce((a,b)=>a+b,0)/intervals.length;
        let consistent = intervals.every(intv => Math.abs(intv - avg) < 10);
        if (consistent) {
          triggerPandemonium();
          levelsThisMinute = 0;
          fightAllowed = false;
          return;
        }
      }
    }
    function upgrade() {
      if (pandActive) return;
      const t = translations[currentLanguage];
      if (level >= 3) {
        level -= 2;
        multiplier++;
        const baseXP = getBaseXP(level);
        if (xp > baseXP) xp = baseXP;
        saveGame();
        updateUI();
      } else {
        alert(t.needLevels);
      }
    }
    function clearData() {
      const t = translations[currentLanguage];
      if (confirm(t.confirmClear)) {
        // Reset all data
        xp = 0; level = 1; multiplier = 1; currentLanguage = 'en';
        gameData = { xp: 0, level: 1, multiplier: 1, colorPalette: 'default' };
        document.getElementById('colorPalette').value = 'default';
        document.getElementById('languageSelect').value = 'en';
        changeColorPalette('default');
        updateLanguage();
      }
    }
    document.getElementById('fightBtn').addEventListener('click', fight);
    document.getElementById('upgradeBtn').addEventListener('click', upgrade);
    document.getElementById('clearDataBtn').addEventListener('click', clearData);
    
    // Make sure UI updates after everything is loaded
    window.addEventListener('load', function() {
      updateUI();
    });

    // --------- Pandemonium: Fullscreen Ball Minigame (dynamic play area, 42s, bar/text tracked to ring) ---------
    let pandBarVal = 1, pandBarDrain = 0.017, pandBarFill = 0.027, pandDuration = 42, pandElapsed = 0;
    let pandInterval = null, pandThrowInterval = null, shakeloop = null;
    let ballX = 0, ballY = 0, shakeTime = 0, shakePhaseX = Math.random()*100, shakePhaseY = Math.random()*100;
    let pandActive = false;
    const ballRadius = 20, ringRadius = 80; // center ring 160px diameter

    function triggerPandemonium() {
      const t = translations[currentLanguage];
      pandActive = true; pandBarVal = 1; pandElapsed = 0;
      centerRingAndElements();
      centerBall();
      document.getElementById('pandemoniumOverlay').style.display = 'flex';
      updateBall();
      document.getElementById('pandStatus').textContent = t.pandKeepInside;
      document.getElementById('pandStartBtn').textContent = t.pandStart;
      document.getElementById('pandStartBtn').style.display = 'block';
      document.getElementById('pandStartBtn').onclick = function() {
        document.getElementById('pandStartBtn').style.display = 'none';
        let gameBox = document.getElementById('pandGameBox');
        gameBox.requestPointerLock = gameBox.requestPointerLock || gameBox.mozRequestPointerLock;
        gameBox.requestPointerLock();
      };
      window.addEventListener("resize", centerRingAndElements);
    }

    document.addEventListener('pointerlockchange', pointerLockChange, false);
    document.addEventListener('mozpointerlockchange', pointerLockChange, false);

    function pointerLockChange() {
      let locked = document.pointerLockElement === document.getElementById('pandGameBox') ||
          document.mozPointerLockElement === document.getElementById('pandGameBox');
      if (locked && pandActive) startPandemoniumCore();
    }

    function centerRingAndElements() {
      const cx = window.innerWidth/2, cy = window.innerHeight/2;
      const d  = ringRadius*2;

      // Center the ring
      let ring = document.getElementById('pandCenterRing');
      ring.style.width = d+'px';
      ring.style.height = d+'px';
      ring.style.left = (cx - ringRadius)+'px';
      ring.style.top  = (cy - ringRadius)+'px';

      // Status text
      let status = document.getElementById('pandStatus');
      status.style.left = (cx-200)+'px';
      status.style.top = (cy - ringRadius - 75) + 'px';

      // XP bar
      let bar = document.getElementById('pandBarContainer');
      bar.style.left = (cx-160)+'px';
      bar.style.top = (cy + ringRadius + 40) + 'px';
      bar.style.width = '320px';
    }

    function centerBall() {
      ballX = window.innerWidth/2;
      ballY = window.innerHeight/2;
    }
    function startPandemoniumCore() {
      document.body.style.cursor = 'none';
      shakeTime = 0;
      shakeloop = requestAnimationFrame(ballSmoothShake);
      pandThrowInterval = setInterval(pandThrowBall, 5000);
      pandInterval = setInterval(pandBallTick, 40);
      window.addEventListener("mousemove", moveBallByMouse, false);
      // Play audio on a user gesture
      let a = document.getElementById('pandAudio');
      a.currentTime = 0;
      a.play().catch(()=>{});
    }
    function endPandemoniumCore(win) {
      const t = translations[currentLanguage];
      clearInterval(pandInterval); clearInterval(pandThrowInterval); cancelAnimationFrame(shakeloop);
      window.removeEventListener("mousemove", moveBallByMouse);
      window.removeEventListener("resize", centerRingAndElements);
      document.body.style.cursor = '';
      document.exitPointerLock = document.exitPointerLock || document.mozExitPointerLock;
      try { document.exitPointerLock(); } catch(e) {}
      // Stop/rewind audio
      let a = document.getElementById('pandAudio'); a.pause(); a.currentTime = 0;
      let status = document.getElementById('pandStatus');
      if (win) status.textContent = t.pandSurvived;
      else status.textContent = t.pandFailed;
      document.getElementById('pandemoniumOverlay').onclick = function() {
        document.getElementById('pandemoniumOverlay').style.display = 'none';
        document.getElementById('pandemoniumOverlay').onclick = null;
        fightAllowed = true;
        if (!win) triggerPandemonium();
      }
    }
    function moveBallByMouse(e) {
      if (!pandActive) return;
      ballX += e.movementX;
      ballY += e.movementY;
      // Ball must stay fully onscreen
      ballX = Math.max(ballRadius, Math.min(window.innerWidth-ballRadius, ballX));
      ballY = Math.max(ballRadius, Math.min(window.innerHeight-ballRadius, ballY));
    }
    function updateBall() {
      let el = document.getElementById('pandCursorBall');
      el.style.left = (ballX-ballRadius) + 'px';
      el.style.top = (ballY-ballRadius) + 'px';
    }
    function ballSmoothShake() {
      shakeTime += 0.04;
      let maxShake = 5;
      let shakeX = Math.sin(shakePhaseX + shakeTime*0.8)*maxShake + Math.sin(shakePhaseY + shakeTime*1.3)*maxShake*0.6;
      let shakeY = Math.cos(shakePhaseY + shakeTime*0.85)*maxShake + Math.cos(shakePhaseX + shakeTime*1.11)*maxShake*0.5;
      let el = document.getElementById('pandCursorBall');
      el.style.left = (ballX-ballRadius+shakeX)+'px';
      el.style.top = (ballY-ballRadius+shakeY)+'px';
      if (pandActive) shakeloop = requestAnimationFrame(ballSmoothShake);
    }
    function pandBallTick() {
      let dx = ballX - window.innerWidth/2, dy = ballY - window.innerHeight/2;
      let inRing = Math.sqrt(dx*dx+dy*dy) <= ringRadius;
      if (inRing) {
        pandBarVal = Math.min(1, pandBarVal + pandBarFill);
        pandElapsed += 0.04;
      } else {
        pandBarVal = Math.max(0, pandBarVal - pandBarDrain);
      }
      document.getElementById('pandBar').style.width = (pandBarVal*100) + "%";
      if (pandElapsed >= pandDuration) endPandemoniumCore(true);
      if (pandBarVal <= 0) endPandemoniumCore(false);
    }
    function pandThrowBall() {
      // Knock anywhere onscreen (at least 50px from center, inside bounds)
      let cx = window.innerWidth/2, cy = window.innerHeight/2;
      let minDist = ringRadius + 50,
          maxDist = Math.min(cx, cy) - ballRadius - 10;
      if (maxDist < minDist+1) maxDist = minDist+1;
      let angle = Math.random()*Math.PI*2;
      let r = minDist + Math.random() * (maxDist-minDist);
      let tryX = cx + Math.cos(angle)*r;
      let tryY = cy + Math.sin(angle)*r;
      // Clamp to window bounds
      tryX = Math.max(ballRadius, Math.min(window.innerWidth-ballRadius, tryX));
      tryY = Math.max(ballRadius, Math.min(window.innerHeight-ballRadius, tryY));
      ballX = tryX;
      ballY = tryY;
    }
  </script>
</body>
</html>
