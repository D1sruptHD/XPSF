<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XPSF: Infinite</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <style>
    :root {
      --bg: black; --txt: #0f0; --acc: #0f0; --sec: #030; --btn: #300; --hover: #500;
    }
    * { box-sizing: border-box; }
    body {
      background: var(--bg); color: var(--txt); font-family: monospace; margin: 0;
      display: flex; flex-direction: column; align-items: center; padding: 2rem;
      height: 100vh; position: relative;
    }
    .fixed { position: fixed; z-index: 9999; font-family: monospace; }
    .palette-selector { top: 10px; right: 10px; }
    .language-selector { top: 50px; right: 10px; }
    .palette-selector label, .language-selector label {
      color: var(--txt); font-size: 0.8rem; margin-right: 8px;
    }
    .palette-selector select, .language-selector select {
      background: var(--btn); color: var(--txt); border: 1px solid var(--acc);
      border-radius: 4px; padding: 4px 8px; font: inherit; font-size: 0.75rem; cursor: pointer;
    }
    #clearDataBtn {
      top: 10px; left: 10px; background: var(--btn); border: 1.5px solid var(--acc);
      color: var(--txt); border-radius: 8px; padding: 6px 10px; font-size: 0.75rem;
      cursor: pointer; opacity: 0.6; transition: all 0.3s; user-select: none; font: inherit;
    }
    #clearDataBtn:hover { background: var(--hover); opacity: 1; }
    h1 { margin-bottom: 1rem; font-size: 2rem; }
    .stat { margin: 0.5rem 0; font-size: 1.2rem; }
    #xp-bar {
      width: 80%; max-width: 400px; height: 30px; background: var(--sec);
      border: 2px solid var(--acc); border-radius: 12px; margin: 1rem 0; overflow: hidden;
    }
    #xp-fill {
      height: 100%; background: var(--acc); width: 0%; transition: width 0.3s ease;
      border-radius: 10px 0 0 10px;
    }
    #xp-fill.full { border-radius: 10px; }
    .button-group { display: flex; gap: 1rem; margin-top: 2rem; }
    button {
      background: var(--btn); border: 2px solid var(--acc); color: var(--txt);
      border-radius: 10px; padding: 12px 24px; font: inherit; cursor: pointer;
      transition: all 0.2s; user-select: none;
    }
    button:hover { background: var(--hover); }
    button:active { transform: scale(0.95); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    #saveIndicator {
      position: fixed; bottom: 10px; right: 10px; background: rgba(0,255,0,0.8);
      color: black; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem;
      opacity: 0; transition: opacity 0.3s; z-index: 9999; font: inherit;
    }
    #saveIndicator.show { opacity: 1; }
    
    /* Pandemonium styles */
    #pandemoniumOverlay {
      display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: 10000; background: rgba(0,0,0,0.9); align-items: center; justify-content: center;
      flex-direction: column; cursor: none;
    }
    #pandGameBox { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 2; }
    #pandCenterRing { position: fixed; border: 5px solid #f36; border-radius: 50%; pointer-events: none; z-index: 3; }
    #pandCursorBall {
      position: fixed; width: 40px; height: 40px; border-radius: 50%; background: #1e6;
      box-shadow: 0 0 15px #fff; border: 2px solid #fff; z-index: 4; pointer-events: none;
    }
    #pandBarContainer {
      height: 28px; background: #222; border: 2px solid #fff; border-radius: 13px;
      overflow: hidden; z-index: 15; position: fixed;
    }
    #pandBar { height: 100%; background: #1e6; transition: width 0.1s; }
    #pandStatus {
      color: #fff; font-size: 1.1rem; z-index: 15; position: fixed; text-align: center;
    }
    #pandStartBtn {
      margin-top: 32px; font: inherit; font-size: 1.1rem; padding: 10px 30px;
      border-radius: 8px; border: 2px solid #888; background: #181818;
      color: #fff; cursor: pointer; z-index: 16;
    }
  </style>
</head>
<body>
  <div id="saveIndicator">Saved!</div>
  
  <div class="palette-selector fixed">
    <label for="colorPalette" id="themeLabel">Theme:</label>
    <select id="colorPalette">
      <option value="default">Default</option>
      <option value="blue">Blue/Yellow</option>
      <option value="white">White/Black</option>
      <option value="contrast">High Contrast</option>
    </select>
  </div>
  
  <div class="language-selector fixed">
    <label for="languageSelect" id="langLabel">Lang:</label>
    <select id="languageSelect">
      <option value="en">EN</option>
      <option value="hu">HU</option>
      <option value="ru">RU</option>
    </select>
  </div>
  
  <button id="clearDataBtn" class="fixed">Clear</button>
  
  <h1 id="gameTitle">XPSF: Infinite</h1>
  <div class="stat" id="levelDisplay">Level: 1</div>
  <div class="stat" id="xpDisplay">XP: 0 / 100</div>
  <div class="stat" id="xpLeftDisplay">XP Left: 100</div>
  <div class="stat" id="upgradeDisplay">Multiplier: 1x</div>
  <div id="xp-bar"><div id="xp-fill"></div></div>
  <div class="button-group">
    <button id="fightBtn">Fight</button>
    <button id="upgradeBtn">Upgrade (2 Levels)</button>
  </div>
  
  <div id="pandemoniumOverlay">
    <div id="pandGameBox">
      <div id="pandCenterRing"></div>
      <div id="pandCursorBall"></div>
    </div>
    <div id="pandBarContainer"><div id="pandBar"></div></div>
    <div id="pandStatus"></div>
    <button id="pandStartBtn" style="display:none;">Start</button>
  </div>
  
  <audio id="pandAudio" src="audio.mp3" loop></audio>
  
  <script>
    // Optimized game state
    let game = {
      xp: 0, level: 1, mult: 1, theme: 'default', lang: 'en'
    };
    
    const t = {
      en: {
        title: "XPSF: Infinite", clear: "Clear", theme: "Theme:", lang: "Lang:",
        level: "Level", xpLeft: "XP Left", mult: "Multiplier", fight: "Fight",
        upgrade: "Upgrade", needLevels: "Need 3+ levels!", 
        confirmClear: "Delete ALL progress?", pandKeep: "Keep circle inside!",
        pandWin: "Survived! Click to continue.", pandFail: "Failed! Try again."
      },
      hu: {
        title: "XPSF: Végtelen", clear: "Törlés", theme: "Téma:", lang: "Nyelv:",
        level: "Szint", xpLeft: "XP Hátra", mult: "Szorzó", fight: "Harc",
        upgrade: "Fejlesztés", needLevels: "3+ szint kell!",
        confirmClear: "MINDEN törlése?", pandKeep: "Tartsd bent a kört!",
        pandWin: "Túléltél! Kattints.", pandFail: "Kudarc! Újra."
      },
      ru: {
        title: "XPSF: Бесконечность", clear: "Очистить", theme: "Тема:", lang: "Язык:",
        level: "Уровень", xpLeft: "XP Осталось", mult: "Множитель", fight: "Бой",
        upgrade: "Улучшение", needLevels: "Нужно 3+ уровня!",
        confirmClear: "Удалить ВСЁ?", pandKeep: "Держи круг внутри!",
        pandWin: "Выжил! Клик продолжить.", pandFail: "Провал! Ещё раз."
      }
    };

    // Optimized save/load
    const save = () => {
      try {
        window.xpsfSave = JSON.stringify(game);
        document.getElementById('saveIndicator').className = 'show';
        setTimeout(() => document.getElementById('saveIndicator').className = '', 1000);
      } catch(e) { console.warn('Save failed'); }
    };

    const load = () => {
      try {
        if (window.xpsfSave) {
          game = {...game, ...JSON.parse(window.xpsfSave)};
          return true;
        }
      } catch(e) { console.warn('Load failed'); }
      return false;
    };

    // Theme system
    const themes = {
      default: ['black', '#0f0', '#0f0', '#030', '#300', '#500'],
      blue: ['#008', '#ff0', '#ff0', '#004', '#006', '#00a'],
      white: ['white', 'black', '#333', '#f0f0f0', '#e0e0e0', '#d0d0d0'],
      contrast: ['black', 'white', 'white', '#333', '#666', '#888']
    };

    const setTheme = (theme) => {
      const [bg, txt, acc, sec, btn, hover] = themes[theme] || themes.default;
      const r = document.documentElement.style;
      r.setProperty('--bg', bg);
      r.setProperty('--txt', txt);
      r.setProperty('--acc', acc);
      r.setProperty('--sec', sec);
      r.setProperty('--btn', btn);
      r.setProperty('--hover', hover);
      game.theme = theme;
      save();
    };

    // UI updates
    const getBaseXP = (lvl) => 100 + (lvl - 1) * 50;
    
    const updateUI = () => {
      const lang = t[game.lang];
      const baseXP = getBaseXP(game.level);
      
      document.getElementById('gameTitle').textContent = lang.title;
      document.getElementById('clearDataBtn').textContent = lang.clear;
      document.getElementById('themeLabel').textContent = lang.theme;
      document.getElementById('langLabel').textContent = lang.lang;
      
      document.getElementById('levelDisplay').textContent = `${lang.level}: ${game.level}`;
      document.getElementById('xpDisplay').textContent = `XP: ${Math.floor(game.xp)} / ${baseXP}`;
      document.getElementById('xpLeftDisplay').textContent = `${lang.xpLeft}: ${Math.max(0, Math.floor(baseXP - game.xp))}`;
      document.getElementById('upgradeDisplay').textContent = `${lang.mult}: ${game.mult}x`;
      document.getElementById('fightBtn').textContent = lang.fight;
      document.getElementById('upgradeBtn').textContent = `${lang.upgrade} (2 Levels)`;
      
      const pct = Math.min((game.xp / baseXP) * 100, 100);
      const fill = document.getElementById('xp-fill');
      fill.style.width = pct + '%';
      fill.className = pct >= 100 ? 'full' : '';
    };

    // Game logic
    let fightAllowed = true;
    let clickTimes = [];
    let levelsThisMin = 0;
    let minStart = Date.now();

    const fight = () => {
      if (!fightAllowed || pandActive) return;
      
      const now = Date.now();
      clickTimes.push(now);
      if (clickTimes.length > 20) clickTimes.shift();
      
      if (now - minStart > 60000) {
        levelsThisMin = 0;
        minStart = now;
      }
      
      const baseXP = getBaseXP(game.level);
      const gain = (20 + Math.random() * 30) * game.mult;
      const oldLevel = game.level;
      
      game.xp += gain;
      while (game.xp >= getBaseXP(game.level)) {
        game.xp -= getBaseXP(game.level);
        game.level++;
      }
      
      save();
      updateUI();
      
      levelsThisMin += game.level - oldLevel;
      
      // Anti-cheat check
      if (levelsThisMin >= 50 && clickTimes.length === 20) {
        const intervals = clickTimes.slice(1).map((time, i) => time - clickTimes[i]);
        const avg = intervals.reduce((a, b) => a + b) / intervals.length;
        if (intervals.every(int => Math.abs(int - avg) < 10)) {
          startPandemonium();
          levelsThisMin = 0;
          fightAllowed = false;
        }
      }
    };

    const upgrade = () => {
      if (pandActive) return;
      if (game.level >= 3) {
        game.level -= 2;
        game.mult++;
        if (game.xp > getBaseXP(game.level)) game.xp = getBaseXP(game.level);
        save();
        updateUI();
      } else {
        alert(t[game.lang].needLevels);
      }
    };

    const clearData = () => {
      if (confirm(t[game.lang].confirmClear)) {
        game = { xp: 0, level: 1, mult: 1, theme: 'default', lang: 'en' };
        window.xpsfSave = null;
        document.getElementById('colorPalette').value = 'default';
        document.getElementById('languageSelect').value = 'en';
        setTheme('default');
        updateUI();
        save();
      }
    };

    // Pandemonium minigame
    let pandActive = false;
    let pandBar = 1, pandTime = 0;
    let ballX = 0, ballY = 0;
    let pandInt, throwInt, shakeFrame;
    const ballR = 20, ringR = 80;

    const startPandemonium = () => {
      pandActive = true;
      pandBar = 1;
      pandTime = 0;
      
      const cx = innerWidth / 2, cy = innerHeight / 2;
      ballX = cx; ballY = cy;
      
      const ring = document.getElementById('pandCenterRing');
      ring.style.width = ring.style.height = ringR * 2 + 'px';
      ring.style.left = cx - ringR + 'px';
      ring.style.top = cy - ringR + 'px';
      
      const status = document.getElementById('pandStatus');
      status.style.left = cx - 200 + 'px';
      status.style.top = cy - ringR - 75 + 'px';
      status.style.width = '400px';
      status.textContent = t[game.lang].pandKeep;
      
      const barCont = document.getElementById('pandBarContainer');
      barCont.style.left = cx - 160 + 'px';
      barCont.style.top = cy + ringR + 40 + 'px';
      barCont.style.width = '320px';
      
      document.getElementById('pandemoniumOverlay').style.display = 'flex';
      document.getElementById('pandStartBtn').style.display = 'block';
      document.getElementById('pandStartBtn').onclick = () => {
        document.getElementById('pandStartBtn').style.display = 'none';
        document.getElementById('pandGameBox').requestPointerLock();
      };
    };

    const updateBall = () => {
      const ball = document.getElementById('pandCursorBall');
      ball.style.left = ballX - ballR + 'px';
      ball.style.top = ballY - ballR + 'px';
    };

    const pandTick = () => {
      const dx = ballX - innerWidth / 2;
      const dy = ballY - innerHeight / 2;
      const inRing = Math.sqrt(dx * dx + dy * dy) <= ringR;
      
      if (inRing) {
        pandBar = Math.min(1, pandBar + 0.025);
        pandTime += 0.04;
      } else {
        pandBar = Math.max(0, pandBar - 0.015);
      }
      
      document.getElementById('pandBar').style.width = pandBar * 100 + '%';
      
      if (pandTime >= 42) endPandemonium(true);
      if (pandBar <= 0) endPandemonium(false);
    };

    const throwBall = () => {
      const cx = innerWidth / 2, cy = innerHeight / 2;
      const angle = Math.random() * Math.PI * 2;
      const dist = ringR + 100 + Math.random() * 200;
      ballX = Math.max(ballR, Math.min(innerWidth - ballR, cx + Math.cos(angle) * dist));
      ballY = Math.max(ballR, Math.min(innerHeight - ballR, cy + Math.sin(angle) * dist));
    };

    const endPandemonium = (win) => {
      pandActive = false;
      clearInterval(pandInt);
      clearInterval(throwInt);
      cancelAnimationFrame(shakeFrame);
      
      document.exitPointerLock?.();
      document.body.style.cursor = '';
      
      const audio = document.getElementById('pandAudio');
      audio.pause();
      audio.currentTime = 0;
      
      document.getElementById('pandStatus').textContent = win ? t[game.lang].pandWin : t[game.lang].pandFail;
      
      document.getElementById('pandemoniumOverlay').onclick = () => {
        document.getElementById('pandemoniumOverlay').style.display = 'none';
        document.getElementById('pandemoniumOverlay').onclick = null;
        fightAllowed = true;
        if (!win) startPandemonium();
      };
    };

    // Event listeners
    document.getElementById('fightBtn').onclick = fight;
    document.getElementById('upgradeBtn').onclick = upgrade;
    document.getElementById('clearDataBtn').onclick = clearData;
    document.getElementById('colorPalette').onchange = e => setTheme(e.target.value);
    document.getElementById('languageSelect').onchange = e => {
      game.lang = e.target.value;
      updateUI();
      save();
    };

    // Pointer lock events
    document.onpointerlockchange = () => {
      if (document.pointerLockElement && pandActive) {
        document.body.style.cursor = 'none';
        pandInt = setInterval(pandTick, 40);
        throwInt = setInterval(throwBall, 5000);
        
        const shake = () => {
          if (!pandActive) return;
          const t = performance.now() * 0.01;
          const x = Math.sin(t) * 3 + Math.sin(t * 1.3) * 2;
          const y = Math.cos(t * 1.1) * 3 + Math.cos(t * 0.9) * 2;
          const ball = document.getElementById('pandCursorBall');
          ball.style.left = ballX - ballR + x + 'px';
          ball.style.top = ballY - ballR + y + 'px';
          shakeFrame = requestAnimationFrame(shake);
        };
        shake();
        
        document.onmousemove = e => {
          if (!pandActive) return;
          ballX = Math.max(ballR, Math.min(innerWidth - ballR, ballX + e.movementX));
          ballY = Math.max(ballR, Math.min(innerHeight - ballR, ballY + e.movementY));
        };
        
        document.getElementById('pandAudio').play().catch(() => {});
      }
    };

    // Initialize
    onload = () => {
      const loaded = load();
      if (loaded) {
        document.getElementById('colorPalette').value = game.theme;
        document.getElementById('languageSelect').value = game.lang;
        setTheme(game.theme);
      }
      updateUI();
      if (!loaded) save();
    };

    // Auto-save
    setInterval(save, 30000);
    onbeforeunload = save;
  </script>
</body>
</html>
